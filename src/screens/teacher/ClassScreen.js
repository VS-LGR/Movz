import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Alert,
  Image,
  Dimensions,
} from 'react-native';
import CustomAlert from '../../components/CustomAlert';
import useCustomAlert from '../../hooks/useCustomAlert';
import apiService from '../../services/apiService';
import SideMenu from '../../components/SideMenu';

const { width } = Dimensions.get('window');

const ClassScreen = ({ isMenuVisible, setIsMenuVisible, onNavigate, currentUser, onLogout }) => {
  // Usar par√¢metros passados via navega√ß√£o
  const classData = window.navigationParams?.classData || {};

  const [attendanceTaken, setAttendanceTaken] = useState(false);
  const [classCompleted, setClassCompleted] = useState(false);
  const [loading, setLoading] = useState(false);
  const [expandedCard, setExpandedCard] = useState('aquecimento');
  const [showCompletionModal, setShowCompletionModal] = useState(false);
  const { alert, showSuccess, showError, hideAlert } = useCustomAlert();

  // Dados de exemplo dos exerc√≠cios (em produ√ß√£o viria da API)
  const workoutSections = [
    {
      id: 'aquecimento',
      title: 'Aquecimento',
      duration: '7min',
      exercises: [
        { name: 'Corrida Leve', repetitions: '5 minutos' },
        { name: 'Alongamento Din√¢mico', repetitions: '2 minutos' },
        { name: 'Aquecimento Articular', repetitions: '1 s√©rie' },
      ],
    },
    {
      id: 'treino',
      title: 'Treino',
      duration: '30min',
      exercises: [
        { name: 'Saque', repetitions: '20 repeti√ß√µes' },
        { name: 'Recep√ß√£o', repetitions: '20 repeti√ß√µes' },
        { name: 'Levantamento', repetitions: '20 repeti√ß√µes' },
        { name: 'Ataque', repetitions: '20 repeti√ß√µes' },
        { name: 'Bloqueio', repetitions: '20 repeti√ß√µes' },
        { name: 'Defesa', repetitions: '20 repeti√ß√µes' },
      ],
    },
    {
      id: 'desaquecimento',
      title: 'Desaquecimento',
      duration: '8min',
      exercises: [
        { name: 'Alongamento Final', repetitions: '5 minutos' },
        { name: 'Relaxamento', repetitions: '3 minutos' },
      ],
    },
  ];

  const handleTakeAttendance = async () => {
    try {
      setLoading(true);
      // Aqui seria implementada a l√≥gica de chamada
      // Por enquanto, apenas simula o processo
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setAttendanceTaken(true);
      showSuccess('Sucesso! üéâ', 'Chamada realizada com sucesso!');
    } catch (error) {
      showError('‚ùå Erro', 'Erro ao realizar a chamada');
    } finally {
      setLoading(false);
    }
  };

  const handleCompleteClass = () => {
    setShowCompletionModal(true);
  };

  const confirmCompleteClass = async () => {
    try {
      setLoading(true);
      
      console.log('üîµ ClassData:', classData);
      console.log('üîµ Class ID:', classData.id);
      
      if (!classData.id) {
        throw new Error('ID da aula n√£o encontrado');
      }
      
      // Chamar API para marcar aula como conclu√≠da
      const response = await apiService.completeClass(classData.id, true);
      
      if (response.success) {
        setClassCompleted(true);
        setShowCompletionModal(false);
        
        // Marcar que a aula foi conclu√≠da nos par√¢metros de navega√ß√£o
        if (window.navigationParams) {
          window.navigationParams.classCompleted = true;
        }
        
        showSuccess('Sucesso! üéâ', 'Aula conclu√≠da com sucesso!');
        
        // Navegar de volta para a lista de aulas
        onNavigate('teacherClasses');
      } else {
        throw new Error(response.message || 'Erro ao concluir a aula');
      }
    } catch (error) {
      console.error('Erro ao concluir aula:', error);
      showError('‚ùå Erro', error.message || 'Erro ao concluir a aula');
    } finally {
      setLoading(false);
    }
  };

  const renderWorkoutCard = (section) => (
    <TouchableOpacity
      key={section.id}
      style={[
        styles.workoutCard,
        expandedCard === section.id && styles.expandedCard
      ]}
      onPress={() => setExpandedCard(expandedCard === section.id ? null : section.id)}
    >
      <View style={styles.cardHeader}>
        <View style={styles.cardTitleContainer}>
          <Text style={styles.cardTitle}>{section.title}</Text>
          <Text style={styles.cardDuration}>{section.duration}</Text>
        </View>
        <View style={styles.expandIcon}>
          <Text style={styles.expandIconText}>
            {expandedCard === section.id ? '‚àí' : '+'}
          </Text>
        </View>
      </View>
      
      {expandedCard === section.id && (
        <View style={styles.exercisesList}>
          {section.exercises.map((exercise, index) => (
            <View key={index} style={styles.exerciseItem}>
              <View style={styles.exerciseInfo}>
                <Text style={styles.exerciseName}>{exercise.name}</Text>
                <Text style={styles.exerciseReps}>{exercise.repetitions}</Text>
              </View>
            </View>
          ))}
        </View>
      )}
    </TouchableOpacity>
  );

  return (
    <ScrollView style={styles.container}>
      {/* Header */}
      <View style={styles.header}>
        <View style={styles.headerTop}>
          <Text style={styles.logo}>Muvz</Text>
          <TouchableOpacity 
            style={styles.menuLines}
            onPress={() => setIsMenuVisible(true)}
          >
            <View style={styles.menuLine} />
            <View style={styles.menuLine} />
            <View style={styles.menuLine} />
          </TouchableOpacity>
        </View>
        
        <Text style={styles.title}>In√≠cio da Aula</Text>
        <Text style={styles.subtitle}>
          Vamos come√ßar a aula da {classData?.class || '5¬™ s√©rie'}?
        </Text>
        
        <View style={styles.divider} />
        
        <Text style={styles.classTitle}>{classData?.sport || 'Treino de V√¥lei'}</Text>
        <Text style={styles.classInfo}>
          Dura√ß√£o: {classData?.duration || '60min'} Esse treino vale {classData?.xp || '60'}xp para seus alunos
        </Text>
      </View>

      {/* Bot√£o de Chamada */}
      <TouchableOpacity 
        style={[styles.attendanceButton, attendanceTaken && styles.attendanceButtonCompleted]}
        onPress={handleTakeAttendance}
        disabled={attendanceTaken || loading}
      >
        <Text style={styles.attendanceButtonText}>
          {attendanceTaken ? 'Chamada Realizada' : 'Fazer a Chamada'}
        </Text>
      </TouchableOpacity>

      {/* Se√ß√µes de Exerc√≠cios */}
      <View style={styles.workoutContainer}>
        {workoutSections.map(renderWorkoutCard)}
      </View>

      {/* Bot√£o de Conclus√£o */}
      <TouchableOpacity 
        style={[styles.completeButton, classCompleted && styles.completeButtonCompleted]}
        onPress={handleCompleteClass}
        disabled={classCompleted || loading}
      >
        <Text style={styles.completeButtonText}>
          {classCompleted ? 'Aula Conclu√≠da' : 'Concluir Aula'}
        </Text>
      </TouchableOpacity>

      {/* Modal de Confirma√ß√£o de Conclus√£o */}
      {showCompletionModal && (
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Concluir Aula</Text>
            <Text style={styles.modalMessage}>
              Tem certeza que deseja concluir esta aula? Esta a√ß√£o n√£o pode ser desfeita.
            </Text>
            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => setShowCompletionModal(false)}
              >
                <Text style={styles.cancelButtonText}>Cancelar</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[styles.modalButton, styles.confirmButton]}
                onPress={confirmCompleteClass}
                disabled={loading}
              >
                <Text style={styles.confirmButtonText}>
                  {loading ? 'Concluindo...' : 'Confirmar'}
                </Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      )}
      
      <SideMenu 
        isVisible={isMenuVisible} 
        onClose={() => setIsMenuVisible(false)} 
        onNavigate={onNavigate}
        currentUser={currentUser}
        onLogout={onLogout}
        userType="TEACHER"
      />
      
      <CustomAlert
        visible={alert.visible}
        title={alert.title}
        message={alert.message}
        type={alert.type}
        onClose={hideAlert}
      />
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#E8EDED',
  },
  header: {
    padding: 20,
    paddingTop: 40,
  },
  headerTop: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
  },
  logo: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#000',
  },
  menuLines: {
    flexDirection: 'column',
    gap: 3,
  },
  menuLine: {
    width: 39,
    height: 6,
    backgroundColor: '#D9D9D9',
  },
  title: {
    fontSize: 30,
    fontWeight: 'bold',
    color: '#000',
    marginBottom: 10,
  },
  subtitle: {
    fontSize: 18,
    color: '#000',
    marginBottom: 20,
  },
  divider: {
    height: 1,
    backgroundColor: '#000',
    marginBottom: 20,
  },
  classTitle: {
    fontSize: 36,
    fontWeight: 'bold',
    color: '#000',
    textAlign: 'center',
    marginBottom: 10,
  },
  classInfo: {
    fontSize: 18,
    color: '#000',
    textAlign: 'center',
    marginBottom: 20,
  },
  attendanceButton: {
    backgroundColor: '#B5B5B5',
    marginHorizontal: 20,
    marginBottom: 20,
    paddingVertical: 15,
    borderRadius: 10,
    alignItems: 'center',
  },
  attendanceButtonCompleted: {
    backgroundColor: '#4CAF50',
  },
  attendanceButtonText: {
    fontSize: 18,
    fontWeight: '600',
    color: '#000',
  },
  workoutContainer: {
    paddingHorizontal: 20,
    marginBottom: 20,
  },
  workoutCard: {
    backgroundColor: '#fff',
    borderRadius: 15,
    marginBottom: 15,
    padding: 20,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  expandedCard: {
    shadowOpacity: 0.2,
    elevation: 5,
  },
  cardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  cardTitleContainer: {
    flex: 1,
  },
  cardTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#000',
    marginBottom: 5,
  },
  cardDuration: {
    fontSize: 14,
    color: '#666',
    fontFamily: 'Poppins',
  },
  expandIcon: {
    width: 30,
    height: 30,
    borderRadius: 15,
    backgroundColor: '#F9BB55',
    justifyContent: 'center',
    alignItems: 'center',
  },
  expandIconText: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#000',
  },
  exercisesList: {
    marginTop: 15,
    paddingTop: 15,
    borderTopWidth: 1,
    borderTopColor: '#E0E0E0',
  },
  exerciseItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 10,
    paddingHorizontal: 15,
    backgroundColor: '#F8F9FA',
    borderRadius: 10,
    marginBottom: 8,
  },
  exerciseInfo: {
    flex: 1,
  },
  exerciseName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#000',
    marginBottom: 4,
  },
  exerciseReps: {
    fontSize: 14,
    color: '#666',
    fontFamily: 'Poppins',
  },
  completeButton: {
    backgroundColor: '#B5B5B5',
    marginHorizontal: 20,
    marginBottom: 40,
    paddingVertical: 15,
    borderRadius: 10,
    alignItems: 'center',
  },
  completeButtonCompleted: {
    backgroundColor: '#4CAF50',
  },
  completeButtonText: {
    fontSize: 18,
    fontWeight: '600',
    color: '#000',
  },
  modalOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 1000,
  },
  modalContent: {
    backgroundColor: '#fff',
    borderRadius: 20,
    padding: 30,
    marginHorizontal: 20,
    maxWidth: 400,
    width: '100%',
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8,
  },
  modalTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#000',
    textAlign: 'center',
    marginBottom: 15,
  },
  modalMessage: {
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
    marginBottom: 25,
    lineHeight: 22,
  },
  modalButtons: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    gap: 15,
  },
  modalButton: {
    flex: 1,
    paddingVertical: 12,
    borderRadius: 10,
    alignItems: 'center',
  },
  cancelButton: {
    backgroundColor: '#E0E0E0',
  },
  confirmButton: {
    backgroundColor: '#F9BB55',
  },
  cancelButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#666',
  },
  confirmButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#000',
  },
});

export default ClassScreen;
